<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Fetch streams</title>
    <style>
      .wrapper {
        display: flex;
      }
      #preview {
        flex: 1;
        overflow: scroll;
        max-height: 100vh;
      }
      #source {
        overflow: auto;
        max-height: 100vh;
      }
    </style>
    <script src="https://unpkg.com/web-streams-polyfill/dist/polyfill.min.js"></script>
  </head>
  <body>
    <div class="wrapper">
      <p id="preview"></p>
      <pre id="source"></pre>
    </div>

    <script>
      const textElement = document.getElementById('preview');

      document.getElementById('source').innerText =
        document.scripts[1].innerText;

      fetch('/api/stream').then((res) => {
        return res.body
          .pipeThrough(new TextDecoderStream())
          .pipeThrough(upperCaseStream())
          .pipeTo(htmlWriterStream());
      });

      function htmlWriterStream() {
        return new WritableStream({
          write(chunk) {
            textElement.innerText += chunk;
          },
        });
      }

      function upperCaseStream() {
        return new TransformStream({
          transform(chunk, controller) {
            controller.enqueue(chunk.toUpperCase());
          },
        });
      }
    </script>
  </body>
</html>
